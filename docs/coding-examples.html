
<!DOCTYPE html>

<html class="writer-html5" data-content_root="./" lang="en">
<head>
<meta charset="utf-8"/><meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Coding Examples and Scripts — Storage Systems and Data Management Guide 1.0 documentation</title>
<link href="_static/pygments.css?v=b86133f3" rel="stylesheet" type="text/css"/>
<link href="_static/css/theme.css?v=e59714d7" rel="stylesheet" type="text/css"/>
<link href="_static/css/navigation-fix.css" rel="stylesheet" type="text/css"/>
<script src="_static/jquery.js?v=5d32c60e"></script>
<script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
<script src="_static/documentation_options.js?v=f2a433a1"></script>
<script src="_static/doctools.js?v=9bcbadda"></script>
<script src="_static/sphinx_highlight.js?v=dc90522c"></script>
<script src="_static/js/theme.js"></script>
<script src="_static/js/navigation-enhancement.js"></script>
<link href="genindex.html" rel="index" title="Index"/>
<link href="search.html" rel="search" title="Search"/>
<link href="troubleshooting.html" rel="next" title="Troubleshooting Guide"/>
<link href="ubuntu-setup.html" rel="prev" title="Ubuntu 22.04 Setup and Configuration"/>
</head>
<body class="wy-body-for-nav">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href="index.html">
            Storage Systems and Data Management Guide
          </a>
<div role="search">
<form action="search.html" class="wy-form" id="rtd-search-form" method="get">
<input aria-label="Search docs" name="q" placeholder="Search docs" type="text"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
</div>
</div><div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<p class="caption" role="heading"><span class="caption-text">Storage Fundamentals:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="storage-overview.html">Storage Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="disk-management.html">Disk Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="file-systems.html">File Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-organization.html">Data Organization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Storage Concepts:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="raid-systems.html">RAID Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="network-storage.html">Network Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="volume-management.html">Volume Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="storage-devices.html">Storage Devices</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Practical Implementation:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ubuntu-setup.html">Ubuntu 22.04 Setup and Configuration</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Coding Examples and Scripts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#storage-monitoring-scripts">Storage Monitoring Scripts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#system-storage-health-monitor">System Storage Health Monitor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#automated-backup-script">Automated Backup Script</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#raid-management-tools">RAID Management Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#raid-status-checker">RAID Status Checker</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#lvm-automation-scripts">LVM Automation Scripts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#dynamic-lv-resize-script">Dynamic LV Resize Script</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#network-storage-utilities">Network Storage Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#nfs-mount-manager">NFS Mount Manager</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#file-system-utilities">File System Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#filesystem-health-checker">Filesystem Health Checker</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#performance-testing-scripts">Performance Testing Scripts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#storage-benchmark-suite">Storage Benchmark Suite</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#installation-and-usage-instructions">Installation and Usage Instructions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-the-environment">Setting Up the Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#script-configuration">Script Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#integration-examples">Integration Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#systemd-service-integration">Systemd Service Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-alerts-integration">Custom Alerts Integration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="best-practices.html">Best Practices and Guidelines</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Resources:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html#common-command-abbreviations">Common Command Abbreviations</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html#storage-unit-definitions">Storage Unit Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html#performance-metrics">Performance Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html#raid-levels-reference">RAID Levels Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html#network-storage-protocols">Network Storage Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html#file-system-features">File System Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="downloads.html">Downloads and Resources</a></li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift"><nav aria-label="Mobile navigation menu" class="wy-nav-top">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="index.html">Storage Systems and Data Management Guide</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content">
<div aria-label="Page navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a aria-label="Home" class="icon icon-home" href="index.html"></a></li>
<li class="breadcrumb-item active">Coding Examples and Scripts</li>
<li class="wy-breadcrumbs-aside">
<a href="_sources/coding-examples.rst.txt" rel="nofollow"> View page source</a>
</li>
</ul>
<hr/>
</div><section id="coding-examples-and-scripts">
<h2>Coding Examples and Scripts<a class="headerlink" href="#coding-examples-and-scripts" title="Link to this heading"></a></h2>
<p>This section provides practical coding examples, scripts, and automation tools for storage management on Ubuntu 22.04.</p>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#storage-monitoring-scripts" id="id1">Storage Monitoring Scripts</a></p>
<ul>
<li><p><a class="reference internal" href="#system-storage-health-monitor" id="id2">System Storage Health Monitor</a></p></li>
<li><p><a class="reference internal" href="#automated-backup-script" id="id3">Automated Backup Script</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#raid-management-tools" id="id4">RAID Management Tools</a></p>
<ul>
<li><p><a class="reference internal" href="#raid-status-checker" id="id5">RAID Status Checker</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#lvm-automation-scripts" id="id6">LVM Automation Scripts</a></p>
<ul>
<li><p><a class="reference internal" href="#dynamic-lv-resize-script" id="id7">Dynamic LV Resize Script</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#network-storage-utilities" id="id8">Network Storage Utilities</a></p>
<ul>
<li><p><a class="reference internal" href="#nfs-mount-manager" id="id9">NFS Mount Manager</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#file-system-utilities" id="id10">File System Utilities</a></p>
<ul>
<li><p><a class="reference internal" href="#filesystem-health-checker" id="id11">Filesystem Health Checker</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#performance-testing-scripts" id="id12">Performance Testing Scripts</a></p>
<ul>
<li><p><a class="reference internal" href="#storage-benchmark-suite" id="id13">Storage Benchmark Suite</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#installation-and-usage-instructions" id="id14">Installation and Usage Instructions</a></p>
<ul>
<li><p><a class="reference internal" href="#setting-up-the-environment" id="id15">Setting Up the Environment</a></p></li>
<li><p><a class="reference internal" href="#script-configuration" id="id16">Script Configuration</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#integration-examples" id="id17">Integration Examples</a></p>
<ul>
<li><p><a class="reference internal" href="#systemd-service-integration" id="id18">Systemd Service Integration</a></p></li>
<li><p><a class="reference internal" href="#custom-alerts-integration" id="id19">Custom Alerts Integration</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="storage-monitoring-scripts">
<h3><a class="toc-backref" href="#id1" role="doc-backlink">Storage Monitoring Scripts</a><a class="headerlink" href="#storage-monitoring-scripts" title="Link to this heading"></a></h3>
<section id="system-storage-health-monitor">
<h4><a class="toc-backref" href="#id2" role="doc-backlink">System Storage Health Monitor</a><a class="headerlink" href="#system-storage-health-monitor" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">"""</span>
<span class="sd">Storage Health Monitor for Ubuntu 22.04</span>
<span class="sd">Monitors disk usage, SMART status, and filesystem health</span>
<span class="sd">"""</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">StorageMonitor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="s2">"/var/log/storage-monitor.log"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_disk_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get disk usage for all mounted filesystems"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">'df'</span><span class="p">,</span> <span class="s1">'-h'</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">"Error getting disk usage: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_smart_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Check SMART status for a device"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">'smartctl'</span><span class="p">,</span> <span class="s1">'-H'</span><span class="p">,</span> <span class="n">device</span><span class="p">],</span>
                                  <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">"PASSED"</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_mounted_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get list of mounted block devices"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">'lsblk'</span><span class="p">,</span> <span class="s1">'-J'</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="n">devices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">'blockdevices'</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'mountpoint'</span><span class="p">):</span>
                    <span class="n">devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">device</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">devices</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Log status message with timestamp"""</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S"</span><span class="p">)</span>
        <span class="n">log_entry</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_entry</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error writing to log: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Main monitoring function"""</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Storage Health Monitor - Starting..."</span><span class="p">)</span>

        <span class="c1"># Check disk usage</span>
        <span class="n">usage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_disk_usage</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Disk Usage:"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">usage</span><span class="p">)</span>

        <span class="c1"># Check SMART status for physical drives</span>
        <span class="n">devices</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'/dev/sda'</span><span class="p">,</span> <span class="s1">'/dev/sdb'</span><span class="p">,</span> <span class="s1">'/dev/nvme0n1'</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">smart_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_smart_status</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">"HEALTHY"</span> <span class="k">if</span> <span class="n">smart_ok</span> <span class="k">else</span> <span class="s2">"WARNING"</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"SMART status for </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">"</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_status</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not check </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Alert on high usage</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">usage</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">usage_pct</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'%'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">usage_pct</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">usage_pct</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
                        <span class="n">alert</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"HIGH USAGE ALERT: </span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">usage_pct</span><span class="si">}</span><span class="s2">% full"</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log_status</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">monitor</span> <span class="o">=</span> <span class="n">StorageMonitor</span><span class="p">()</span>
    <span class="n">monitor</span><span class="o">.</span><span class="n">monitor</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="automated-backup-script">
<h4><a class="toc-backref" href="#id3" role="doc-backlink">Automated Backup Script</a><a class="headerlink" href="#automated-backup-script" title="Link to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Automated Backup Script for Ubuntu 22.04</span>
<span class="c1"># Supports incremental backups with rotation</span>

<span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail

<span class="c1"># Configuration</span>
<span class="nv">SOURCE_DIR</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="p">/home</span><span class="si">}</span><span class="s2">"</span>
<span class="nv">BACKUP_BASE</span><span class="o">=</span><span class="s2">"/backup"</span>
<span class="nv">RETENTION_DAYS</span><span class="o">=</span><span class="m">30</span>
<span class="nv">LOG_FILE</span><span class="o">=</span><span class="s2">"/var/log/backup.log"</span>
<span class="nv">DATE</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m%d_%H%M%S<span class="k">)</span>
<span class="nv">BACKUP_DIR</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">BACKUP_BASE</span><span class="si">}</span><span class="s2">/backup_</span><span class="si">${</span><span class="nv">DATE</span><span class="si">}</span><span class="s2">"</span>

<span class="c1"># Functions</span>
log_message<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="k">$(</span>date<span class="w"> </span><span class="s1">'+%Y-%m-%d %H:%M:%S'</span><span class="k">)</span><span class="s2"> - </span><span class="nv">$1</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="s2">"</span><span class="nv">$LOG_FILE</span><span class="s2">"</span>
<span class="o">}</span>

check_prerequisites<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$EUID</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>log_message<span class="w"> </span><span class="s2">"ERROR: This script must be run as root"</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>rsync<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>log_message<span class="w"> </span><span class="s2">"Installing rsync..."</span>
<span class="w">        </span>apt<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>rsync
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">"</span><span class="nv">$BACKUP_BASE</span><span class="s2">"</span>
<span class="o">}</span>

perform_backup<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>log_message<span class="w"> </span><span class="s2">"Starting backup of </span><span class="nv">$SOURCE_DIR</span><span class="s2"> to </span><span class="nv">$BACKUP_DIR</span><span class="s2">"</span>

<span class="w">    </span><span class="c1"># Find most recent backup for incremental</span>
<span class="w">    </span><span class="nv">LATEST_BACKUP</span><span class="o">=</span><span class="k">$(</span>find<span class="w"> </span><span class="s2">"</span><span class="nv">$BACKUP_BASE</span><span class="s2">"</span><span class="w"> </span>-maxdepth<span class="w"> </span><span class="m">1</span><span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-name<span class="w"> </span><span class="s2">"backup_*"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-1<span class="k">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="nv">$LATEST_BACKUP</span><span class="s2">"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">"</span><span class="nv">$LATEST_BACKUP</span><span class="s2">"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>log_message<span class="w"> </span><span class="s2">"Performing incremental backup from </span><span class="nv">$LATEST_BACKUP</span><span class="s2">"</span>
<span class="w">        </span>rsync<span class="w"> </span>-av<span class="w"> </span>--link-dest<span class="o">=</span><span class="s2">"</span><span class="nv">$LATEST_BACKUP</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="nv">$SOURCE_DIR</span><span class="s2">/"</span><span class="w"> </span><span class="s2">"</span><span class="nv">$BACKUP_DIR</span><span class="s2">/"</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span>log_message<span class="w"> </span><span class="s2">"Performing full backup"</span>
<span class="w">        </span>rsync<span class="w"> </span>-av<span class="w"> </span><span class="s2">"</span><span class="nv">$SOURCE_DIR</span><span class="s2">/"</span><span class="w"> </span><span class="s2">"</span><span class="nv">$BACKUP_DIR</span><span class="s2">/"</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># Create backup manifest</span>
<span class="w">    </span>find<span class="w"> </span><span class="s2">"</span><span class="nv">$BACKUP_DIR</span><span class="s2">"</span><span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-exec<span class="w"> </span>sha256sum<span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span><span class="w"> </span>&gt;<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">BACKUP_DIR</span><span class="si">}</span><span class="s2">/manifest.sha256"</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Backup completed: </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">"</span><span class="w"> </span>&gt;<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">BACKUP_DIR</span><span class="si">}</span><span class="s2">/backup_info.txt"</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Source: </span><span class="nv">$SOURCE_DIR</span><span class="s2">"</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">"</span><span class="si">${</span><span class="nv">BACKUP_DIR</span><span class="si">}</span><span class="s2">/backup_info.txt"</span>

<span class="w">    </span>log_message<span class="w"> </span><span class="s2">"Backup completed successfully"</span>
<span class="o">}</span>

cleanup_old_backups<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>log_message<span class="w"> </span><span class="s2">"Cleaning up backups older than </span><span class="nv">$RETENTION_DAYS</span><span class="s2"> days"</span>
<span class="w">    </span>find<span class="w"> </span><span class="s2">"</span><span class="nv">$BACKUP_BASE</span><span class="s2">"</span><span class="w"> </span>-maxdepth<span class="w"> </span><span class="m">1</span><span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-name<span class="w"> </span><span class="s2">"backup_*"</span><span class="w"> </span>-mtime<span class="w"> </span>+<span class="nv">$RETENTION_DAYS</span><span class="w"> </span>-exec<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span>
<span class="w">    </span>log_message<span class="w"> </span><span class="s2">"Cleanup completed"</span>
<span class="o">}</span>

<span class="c1"># Main execution</span>
main<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>log_message<span class="w"> </span><span class="s2">"=== Backup Process Started ==="</span>
<span class="w">    </span>check_prerequisites
<span class="w">    </span>perform_backup
<span class="w">    </span>cleanup_old_backups
<span class="w">    </span>log_message<span class="w"> </span><span class="s2">"=== Backup Process Completed ==="</span>
<span class="o">}</span>

<span class="c1"># Error handling</span>
<span class="nb">trap</span><span class="w"> </span><span class="s1">'log_message "ERROR: Backup failed on line $LINENO"'</span><span class="w"> </span>ERR

main<span class="w"> </span><span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
</pre></div>
</div>
</section>
</section>
<section id="raid-management-tools">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">RAID Management Tools</a><a class="headerlink" href="#raid-management-tools" title="Link to this heading"></a></h3>
<section id="raid-status-checker">
<h4><a class="toc-backref" href="#id5" role="doc-backlink">RAID Status Checker</a><a class="headerlink" href="#raid-status-checker" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">"""</span>
<span class="sd">RAID Status Checker for Ubuntu 22.04</span>
<span class="sd">Monitors software RAID arrays and hardware RAID controllers</span>
<span class="sd">"""</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RAIDMonitor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mdstat_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">'/proc/mdstat'</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_software_raid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Check software RAID status from /proc/mdstat"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdstat_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">"status"</span><span class="p">:</span> <span class="s2">"no_raid"</span><span class="p">,</span> <span class="s2">"message"</span><span class="p">:</span> <span class="s2">"No software RAID detected"</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdstat_path</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="n">arrays</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'md'</span><span class="p">):</span>
                    <span class="n">array_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_md_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array_info</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span><span class="s2">"status"</span><span class="p">:</span> <span class="s2">"active"</span><span class="p">,</span> <span class="s2">"arrays"</span><span class="p">:</span> <span class="n">arrays</span><span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">"status"</span><span class="p">:</span> <span class="s2">"error"</span><span class="p">,</span> <span class="s2">"message"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse_md_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">md_line</span><span class="p">,</span> <span class="n">following_lines</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Parse mdstat line for array information"""</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">md_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">array_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">array_status</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">"unknown"</span>

        <span class="c1"># Look for status in following lines</span>
        <span class="n">status_line</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">following_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'md'</span><span class="p">):</span>
                <span class="n">status_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">break</span>

        <span class="c1"># Check for rebuild/sync status</span>
        <span class="n">rebuild_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">'\[.*\]\s+.*=\s*(\d+\.\d+)%'</span><span class="p">,</span> <span class="n">status_line</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">"name"</span><span class="p">:</span> <span class="n">array_name</span><span class="p">,</span>
            <span class="s2">"status"</span><span class="p">:</span> <span class="n">array_status</span><span class="p">,</span>
            <span class="s2">"devices"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_devices</span><span class="p">(</span><span class="n">md_line</span><span class="p">),</span>
            <span class="s2">"rebuilding"</span><span class="p">:</span> <span class="n">rebuild_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">rebuild_match</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"details"</span><span class="p">:</span> <span class="n">status_line</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">md_line</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Extract device list from md line"""</span>
        <span class="c1"># Simple extraction - could be enhanced</span>
        <span class="n">devices</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">'[a-z]+\d+\[\d+\]'</span><span class="p">,</span> <span class="n">md_line</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">dev</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'['</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_hardware_raid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Check hardware RAID controllers"""</span>
        <span class="n">controllers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check for MegaRAID</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">'megacli'</span><span class="p">,</span> <span class="s1">'-AdpAllInfo'</span><span class="p">,</span> <span class="s1">'-aALL'</span><span class="p">],</span>
                                  <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">controllers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"MegaRAID"</span><span class="p">,</span> <span class="s2">"status"</span><span class="p">:</span> <span class="s2">"detected"</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Check for HP Smart Array</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">'hpacucli'</span><span class="p">,</span> <span class="s1">'ctrl'</span><span class="p">,</span> <span class="s1">'all'</span><span class="p">,</span> <span class="s1">'show'</span><span class="p">],</span>
                                  <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">controllers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"HP Smart Array"</span><span class="p">,</span> <span class="s2">"status"</span><span class="p">:</span> <span class="s2">"detected"</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">controllers</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_full_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get complete RAID status report"""</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"timestamp"</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">'date'</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="s2">"software_raid"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_software_raid</span><span class="p">(),</span>
            <span class="s2">"hardware_raid"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_hardware_raid</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">report</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">monitor</span> <span class="o">=</span> <span class="n">RAIDMonitor</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">get_full_status</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="lvm-automation-scripts">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">LVM Automation Scripts</a><a class="headerlink" href="#lvm-automation-scripts" title="Link to this heading"></a></h3>
<section id="dynamic-lv-resize-script">
<h4><a class="toc-backref" href="#id7" role="doc-backlink">Dynamic LV Resize Script</a><a class="headerlink" href="#dynamic-lv-resize-script" title="Link to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Dynamic Logical Volume Resize Script</span>
<span class="c1"># Automatically extends LV when usage exceeds threshold</span>

<span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail

<span class="c1"># Configuration</span>
<span class="nv">THRESHOLD</span><span class="o">=</span><span class="m">85</span>
<span class="nv">EXTEND_SIZE</span><span class="o">=</span><span class="s2">"1G"</span>
<span class="nv">LOG_FILE</span><span class="o">=</span><span class="s2">"/var/log/lv-autoresize.log"</span>

log_message<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="k">$(</span>date<span class="w"> </span><span class="s1">'+%Y-%m-%d %H:%M:%S'</span><span class="k">)</span><span class="s2"> - </span><span class="nv">$1</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="s2">"</span><span class="nv">$LOG_FILE</span><span class="s2">"</span>
<span class="o">}</span>

check_lv_usage<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">lv_path</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>usage

<span class="w">    </span><span class="nv">usage</span><span class="o">=</span><span class="k">$(</span>df<span class="w"> </span><span class="s2">"</span><span class="nv">$lv_path</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'NR==2 {print $5}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/%//'</span><span class="k">)</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$usage</span><span class="s2">"</span>
<span class="o">}</span>

extend_logical_volume<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">lv_path</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">vg_name</span><span class="o">=</span><span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">lv_name</span><span class="o">=</span><span class="s2">"</span><span class="nv">$3</span><span class="s2">"</span>

<span class="w">    </span>log_message<span class="w"> </span><span class="s2">"Extending </span><span class="nv">$lv_path</span><span class="s2"> by </span><span class="nv">$EXTEND_SIZE</span><span class="s2">"</span>

<span class="w">    </span><span class="c1"># Check VG free space</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>free_space
<span class="w">    </span><span class="nv">free_space</span><span class="o">=</span><span class="k">$(</span>vgs<span class="w"> </span>--noheadings<span class="w"> </span>-o<span class="w"> </span>vg_free<span class="w"> </span>--units<span class="w"> </span>g<span class="w"> </span><span class="s2">"</span><span class="nv">$vg_name</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $1}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/g//'</span><span class="k">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$free_space</span><span class="s2"> &lt; 1"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="w"> </span>-l<span class="k">)</span><span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>log_message<span class="w"> </span><span class="s2">"ERROR: Not enough free space in VG </span><span class="nv">$vg_name</span><span class="s2">"</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># Extend LV</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>lvextend<span class="w"> </span>-L<span class="w"> </span><span class="s2">"+</span><span class="nv">$EXTEND_SIZE</span><span class="s2">"</span><span class="w"> </span><span class="s2">"/dev/</span><span class="nv">$vg_name</span><span class="s2">/</span><span class="nv">$lv_name</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="c1"># Resize filesystem</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span>resize2fs<span class="w"> </span><span class="s2">"/dev/</span><span class="nv">$vg_name</span><span class="s2">/</span><span class="nv">$lv_name</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span>log_message<span class="w"> </span><span class="s2">"Successfully extended </span><span class="nv">$lv_path</span><span class="s2">"</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span>log_message<span class="w"> </span><span class="s2">"ERROR: Failed to resize filesystem for </span><span class="nv">$lv_path</span><span class="s2">"</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span>log_message<span class="w"> </span><span class="s2">"ERROR: Failed to extend LV </span><span class="nv">$lv_path</span><span class="s2">"</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>

monitor_logical_volumes<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="c1"># Get all LVs</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="nv">IFS</span><span class="o">=</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>line<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>lv_path<span class="w"> </span>vg_name<span class="w"> </span>lv_name
<span class="w">        </span><span class="nv">lv_path</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $1}'</span><span class="k">)</span>
<span class="w">        </span><span class="nv">vg_name</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $2}'</span><span class="k">)</span>
<span class="w">        </span><span class="nv">lv_name</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $3}'</span><span class="k">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">"</span><span class="nv">$lv_path</span><span class="s2">"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s2">"</span><span class="nv">$lv_path</span><span class="s2">"</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">"LV"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span>usage
<span class="w">            </span><span class="nv">usage</span><span class="o">=</span><span class="k">$(</span>check_lv_usage<span class="w"> </span><span class="s2">"</span><span class="nv">$lv_path</span><span class="s2">"</span><span class="k">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$usage</span><span class="s2">"</span><span class="w"> </span>-gt<span class="w"> </span><span class="s2">"</span><span class="nv">$THRESHOLD</span><span class="s2">"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span>log_message<span class="w"> </span><span class="s2">"WARNING: </span><span class="nv">$lv_path</span><span class="s2"> usage is </span><span class="si">${</span><span class="nv">usage</span><span class="si">}</span><span class="s2">%, threshold is </span><span class="si">${</span><span class="nv">THRESHOLD</span><span class="si">}</span><span class="s2">%"</span>
<span class="w">                </span>extend_logical_volume<span class="w"> </span><span class="s2">"</span><span class="nv">$lv_path</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="nv">$vg_name</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="nv">$lv_name</span><span class="s2">"</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span>log_message<span class="w"> </span><span class="s2">"INFO: </span><span class="nv">$lv_path</span><span class="s2"> usage is </span><span class="si">${</span><span class="nv">usage</span><span class="si">}</span><span class="s2">% (OK)"</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span><span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>lvs<span class="w"> </span>--noheadings<span class="w"> </span>-o<span class="w"> </span>lv_path,vg_name,lv_name<span class="o">)</span>
<span class="o">}</span>

main<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$EUID</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"This script must be run as root"</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span>log_message<span class="w"> </span><span class="s2">"=== LV Auto-resize Monitor Started ==="</span>
<span class="w">    </span>monitor_logical_volumes
<span class="w">    </span>log_message<span class="w"> </span><span class="s2">"=== LV Auto-resize Monitor Completed ==="</span>
<span class="o">}</span>

main<span class="w"> </span><span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
</pre></div>
</div>
</section>
</section>
<section id="network-storage-utilities">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Network Storage Utilities</a><a class="headerlink" href="#network-storage-utilities" title="Link to this heading"></a></h3>
<section id="nfs-mount-manager">
<h4><a class="toc-backref" href="#id9" role="doc-backlink">NFS Mount Manager</a><a class="headerlink" href="#nfs-mount-manager" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">"""</span>
<span class="sd">NFS Mount Manager for Ubuntu 22.04</span>
<span class="sd">Manages NFS mounts with health checking and auto-recovery</span>
<span class="sd">"""</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span><span class="w"> </span><span class="nc">NFSManager</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="o">=</span><span class="s1">'/etc/nfs-mounts.yaml'</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_file</span> <span class="o">=</span> <span class="n">config_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Load NFS mount configuration"""</span>
        <span class="n">default_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'mounts'</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">'server'</span><span class="p">:</span> <span class="s1">'192.168.1.100'</span><span class="p">,</span>
                    <span class="s1">'export'</span><span class="p">:</span> <span class="s1">'/export/shared'</span><span class="p">,</span>
                    <span class="s1">'mountpoint'</span><span class="p">:</span> <span class="s1">'/mnt/nfs-shared'</span><span class="p">,</span>
                    <span class="s1">'options'</span><span class="p">:</span> <span class="s1">'rw,sync,hard,intr'</span><span class="p">,</span>
                    <span class="s1">'auto_mount'</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">'timeout'</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
            <span class="s1">'retry_count'</span><span class="p">:</span> <span class="mi">3</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error loading config: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default_config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_config</span><span class="p">(</span><span class="n">default_config</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">default_config</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Save configuration to file"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error saving config: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_nfs_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Check if NFS server is reachable"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">'ping'</span><span class="p">,</span> <span class="s1">'-c'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'-W'</span><span class="p">,</span> <span class="s1">'5'</span><span class="p">,</span> <span class="n">server</span><span class="p">],</span>
                                  <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_mounted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mountpoint</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Check if mountpoint is currently mounted"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">'mountpoint'</span><span class="p">,</span> <span class="s1">'-q'</span><span class="p">,</span> <span class="n">mountpoint</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">mount_nfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mount_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Mount an NFS share"""</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">mount_config</span><span class="p">[</span><span class="s1">'server'</span><span class="p">]</span>
        <span class="n">export</span> <span class="o">=</span> <span class="n">mount_config</span><span class="p">[</span><span class="s1">'export'</span><span class="p">]</span>
        <span class="n">mountpoint</span> <span class="o">=</span> <span class="n">mount_config</span><span class="p">[</span><span class="s1">'mountpoint'</span><span class="p">]</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">mount_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'options'</span><span class="p">,</span> <span class="s1">'rw,sync'</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Mounting </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">export</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">mountpoint</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create mountpoint if it doesn't exist</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">mountpoint</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check if already mounted</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mounted</span><span class="p">(</span><span class="n">mountpoint</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Already mounted: </span><span class="si">{</span><span class="n">mountpoint</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Check server connectivity</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_nfs_server</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  ERROR: Cannot reach NFS server </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Mount the share</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nfs_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">export</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'mount'</span><span class="p">,</span> <span class="s1">'-t'</span><span class="p">,</span> <span class="s1">'nfs'</span><span class="p">,</span> <span class="s1">'-o'</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">nfs_source</span><span class="p">,</span> <span class="n">mountpoint</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Successfully mounted </span><span class="si">{</span><span class="n">mountpoint</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  ERROR: Mount failed: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  ERROR: Exception during mount: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">unmount_nfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mountpoint</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Unmount an NFS share"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mounted</span><span class="p">(</span><span class="n">mountpoint</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">'umount'</span><span class="p">,</span> <span class="n">mountpoint</span><span class="p">],</span>
                                      <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Successfully unmounted </span><span class="si">{</span><span class="n">mountpoint</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ERROR: Unmount failed: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">mountpoint</span><span class="si">}</span><span class="s2"> is not mounted"</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ERROR: Exception during unmount: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">mount_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Mount all configured NFS shares"""</span>
        <span class="n">success_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'mounts'</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">mount_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'mounts'</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">mount_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'auto_mount'</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mount_nfs</span><span class="p">(</span><span class="n">mount_config</span><span class="p">):</span>
                    <span class="n">success_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Mounted </span><span class="si">{</span><span class="n">success_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_count</span><span class="si">}</span><span class="s2"> NFS shares"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">success_count</span> <span class="o">==</span> <span class="n">total_count</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">unmount_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Unmount all configured NFS shares"""</span>
        <span class="k">for</span> <span class="n">mount_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'mounts'</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unmount_nfs</span><span class="p">(</span><span class="n">mount_config</span><span class="p">[</span><span class="s1">'mountpoint'</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Check health of all NFS mounts"""</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"NFS Mount Health Check"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">mount_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'mounts'</span><span class="p">]:</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">mount_config</span><span class="p">[</span><span class="s1">'server'</span><span class="p">]</span>
            <span class="n">mountpoint</span> <span class="o">=</span> <span class="n">mount_config</span><span class="p">[</span><span class="s1">'mountpoint'</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Checking </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">mount_config</span><span class="p">[</span><span class="s1">'export'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># Check server</span>
            <span class="n">server_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_nfs_server</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Server reachable: </span><span class="si">{</span><span class="s1">'YES'</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">server_ok</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">'NO'</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># Check mount</span>
            <span class="n">mounted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mounted</span><span class="p">(</span><span class="n">mountpoint</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Mounted: </span><span class="si">{</span><span class="s1">'YES'</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">mounted</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">'NO'</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># Check accessibility</span>
            <span class="k">if</span> <span class="n">mounted</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">mountpoint</span><span class="p">)</span> <span class="o">/</span> <span class="s1">'.nfs_test'</span>
                    <span class="n">test_file</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
                    <span class="n">test_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">"  Accessible: YES"</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">"  Accessible: NO"</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Usage: nfs-manager.py {mount|unmount|health|mount-all|unmount-all}"</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"This script must be run as root"</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">manager</span> <span class="o">=</span> <span class="n">NFSManager</span><span class="p">()</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">"mount-all"</span><span class="p">:</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">mount_all</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">"unmount-all"</span><span class="p">:</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">unmount_all</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">"health"</span><span class="p">:</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">health_check</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unknown command: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="file-system-utilities">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">File System Utilities</a><a class="headerlink" href="#file-system-utilities" title="Link to this heading"></a></h3>
<section id="filesystem-health-checker">
<h4><a class="toc-backref" href="#id11" role="doc-backlink">Filesystem Health Checker</a><a class="headerlink" href="#filesystem-health-checker" title="Link to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Comprehensive Filesystem Health Checker for Ubuntu 22.04</span>

<span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail

<span class="c1"># Configuration</span>
<span class="nv">LOG_FILE</span><span class="o">=</span><span class="s2">"/var/log/filesystem-health.log"</span>
<span class="nv">REPORT_FILE</span><span class="o">=</span><span class="s2">"/tmp/filesystem-health-report.txt"</span>

log_message<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="k">$(</span>date<span class="w"> </span><span class="s1">'+%Y-%m-%d %H:%M:%S'</span><span class="k">)</span><span class="s2"> - </span><span class="nv">$1</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="s2">"</span><span class="nv">$LOG_FILE</span><span class="s2">"</span>
<span class="o">}</span>

check_filesystem_errors<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">device</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">fstype</span><span class="o">=</span><span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">mountpoint</span><span class="o">=</span><span class="s2">"</span><span class="nv">$3</span><span class="s2">"</span>

<span class="w">    </span>log_message<span class="w"> </span><span class="s2">"Checking filesystem errors for </span><span class="nv">$device</span><span class="s2"> (</span><span class="nv">$fstype</span><span class="s2">)"</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">"</span><span class="nv">$fstype</span><span class="s2">"</span><span class="w"> </span><span class="k">in</span>
<span class="w">        </span>ext4<span class="p">|</span>ext3<span class="p">|</span>ext2<span class="o">)</span>
<span class="w">            </span><span class="c1"># Check for ext filesystem errors</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span>error_count
<span class="w">            </span><span class="nv">error_count</span><span class="o">=</span><span class="k">$(</span>tune2fs<span class="w"> </span>-l<span class="w"> </span><span class="s2">"</span><span class="nv">$device</span><span class="s2">"</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">"Filesystem errors behavior"</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"0"</span><span class="k">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span>dumpe2fs<span class="w"> </span>-h<span class="w"> </span><span class="s2">"</span><span class="nv">$device</span><span class="s2">"</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">"has_journal"</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span>log_message<span class="w"> </span><span class="s2">"  Journal filesystem detected"</span>
<span class="w">            </span><span class="k">fi</span>

<span class="w">            </span><span class="c1"># Force check if needed</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span>mount_count<span class="w"> </span>max_count
<span class="w">            </span><span class="nv">mount_count</span><span class="o">=</span><span class="k">$(</span>tune2fs<span class="w"> </span>-l<span class="w"> </span><span class="s2">"</span><span class="nv">$device</span><span class="s2">"</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">"Mount count:"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $3}'</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"0"</span><span class="k">)</span>
<span class="w">            </span><span class="nv">max_count</span><span class="o">=</span><span class="k">$(</span>tune2fs<span class="w"> </span>-l<span class="w"> </span><span class="s2">"</span><span class="nv">$device</span><span class="s2">"</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">"Maximum mount count:"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $4}'</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"0"</span><span class="k">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$max_count</span><span class="s2">"</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s2">"</span><span class="nv">$mount_count</span><span class="s2">"</span><span class="w"> </span>-gt<span class="w"> </span><span class="s2">"</span><span class="nv">$max_count</span><span class="s2">"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span>log_message<span class="w"> </span><span class="s2">"  WARNING: Mount count (</span><span class="nv">$mount_count</span><span class="s2">) exceeds maximum (</span><span class="nv">$max_count</span><span class="s2">)"</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">            </span><span class="p">;;</span>

<span class="w">        </span>xfs<span class="o">)</span>
<span class="w">            </span><span class="c1"># Check XFS filesystem</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span>xfs_info<span class="w"> </span><span class="s2">"</span><span class="nv">$mountpoint</span><span class="s2">"</span><span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span>log_message<span class="w"> </span><span class="s2">"  XFS filesystem appears healthy"</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span>log_message<span class="w"> </span><span class="s2">"  WARNING: XFS filesystem check failed"</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">            </span><span class="p">;;</span>

<span class="w">        </span>btrfs<span class="o">)</span>
<span class="w">            </span><span class="c1"># Check Btrfs filesystem</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span>btrfs<span class="w"> </span>filesystem<span class="w"> </span>show<span class="w"> </span><span class="s2">"</span><span class="nv">$device</span><span class="s2">"</span><span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="nb">local</span><span class="w"> </span>errors
<span class="w">                </span><span class="nv">errors</span><span class="o">=</span><span class="k">$(</span>btrfs<span class="w"> </span>device<span class="w"> </span>stats<span class="w"> </span><span class="s2">"</span><span class="nv">$device</span><span class="s2">"</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-c<span class="w"> </span><span class="s2">"err"</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"0"</span><span class="k">)</span>
<span class="w">                </span>log_message<span class="w"> </span><span class="s2">"  Btrfs error count: </span><span class="nv">$errors</span><span class="s2">"</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">            </span><span class="p">;;</span>
<span class="w">    </span><span class="k">esac</span>
<span class="o">}</span>

check_disk_usage<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>log_message<span class="w"> </span><span class="s2">"Checking disk usage patterns"</span>

<span class="w">    </span>df<span class="w"> </span>-h<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nv">IFS</span><span class="o">=</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>line<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>*<span class="s2">"% /"</span>*<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span>usage
<span class="w">            </span><span class="nv">usage</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $5}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/%//'</span><span class="k">)</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span>mountpoint
<span class="w">            </span><span class="nv">mountpoint</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $6}'</span><span class="k">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$usage</span><span class="s2">"</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">90</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span>log_message<span class="w"> </span><span class="s2">"  CRITICAL: </span><span class="nv">$mountpoint</span><span class="s2"> is </span><span class="si">${</span><span class="nv">usage</span><span class="si">}</span><span class="s2">% full"</span>
<span class="w">            </span><span class="k">elif</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$usage</span><span class="s2">"</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span>log_message<span class="w"> </span><span class="s2">"  WARNING: </span><span class="nv">$mountpoint</span><span class="s2"> is </span><span class="si">${</span><span class="nv">usage</span><span class="si">}</span><span class="s2">% full"</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>
<span class="o">}</span>

check_inode_usage<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span>log_message<span class="w"> </span><span class="s2">"Checking inode usage"</span>

<span class="w">    </span>df<span class="w"> </span>-i<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nv">IFS</span><span class="o">=</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>line<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>*<span class="s2">"% /"</span>*<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span>usage
<span class="w">            </span><span class="nv">usage</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $5}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">'s/%//'</span><span class="k">)</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span>mountpoint
<span class="w">            </span><span class="nv">mountpoint</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $6}'</span><span class="k">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$usage</span><span class="s2">"</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">90</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span>log_message<span class="w"> </span><span class="s2">"  CRITICAL: </span><span class="nv">$mountpoint</span><span class="s2"> inodes </span><span class="si">${</span><span class="nv">usage</span><span class="si">}</span><span class="s2">% used"</span>
<span class="w">            </span><span class="k">elif</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$usage</span><span class="s2">"</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span>log_message<span class="w"> </span><span class="s2">"  WARNING: </span><span class="nv">$mountpoint</span><span class="s2"> inodes </span><span class="si">${</span><span class="nv">usage</span><span class="si">}</span><span class="s2">% used"</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>
<span class="o">}</span>

generate_report<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="o">{</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Filesystem Health Report"</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Generated: </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">"</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"=========================================="</span>
<span class="w">        </span><span class="nb">echo</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"DISK USAGE:"</span>
<span class="w">        </span>df<span class="w"> </span>-h
<span class="w">        </span><span class="nb">echo</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"INODE USAGE:"</span>
<span class="w">        </span>df<span class="w"> </span>-i
<span class="w">        </span><span class="nb">echo</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"MOUNTED FILESYSTEMS:"</span>
<span class="w">        </span>mount<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s1">'^/dev/'</span>
<span class="w">        </span><span class="nb">echo</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"FILESYSTEM TYPES:"</span>
<span class="w">        </span>lsblk<span class="w"> </span>-f
<span class="w">        </span><span class="nb">echo</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"RECENT LOG ENTRIES:"</span>
<span class="w">        </span>tail<span class="w"> </span>-20<span class="w"> </span><span class="s2">"</span><span class="nv">$LOG_FILE</span><span class="s2">"</span>

<span class="w">    </span><span class="o">}</span><span class="w"> </span>&gt;<span class="w"> </span><span class="s2">"</span><span class="nv">$REPORT_FILE</span><span class="s2">"</span>

<span class="w">    </span>log_message<span class="w"> </span><span class="s2">"Health report generated: </span><span class="nv">$REPORT_FILE</span><span class="s2">"</span>
<span class="o">}</span>

main<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$EUID</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"This script should be run as root for complete checks"</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span>log_message<span class="w"> </span><span class="s2">"=== Filesystem Health Check Started ==="</span>

<span class="w">    </span><span class="c1"># Get mounted filesystems</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="nv">IFS</span><span class="o">=</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>line<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>/dev/*<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span>device<span class="w"> </span>fstype<span class="w"> </span>mountpoint
<span class="w">            </span><span class="nv">device</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $1}'</span><span class="k">)</span>
<span class="w">            </span><span class="nv">fstype</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $3}'</span><span class="k">)</span>
<span class="w">            </span><span class="nv">mountpoint</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $2}'</span><span class="k">)</span>

<span class="w">            </span>check_filesystem_errors<span class="w"> </span><span class="s2">"</span><span class="nv">$device</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="nv">$fstype</span><span class="s2">"</span><span class="w"> </span><span class="s2">"</span><span class="nv">$mountpoint</span><span class="s2">"</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span><span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>mount<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s1">'^/dev/'</span><span class="o">)</span>

<span class="w">    </span>check_disk_usage
<span class="w">    </span>check_inode_usage
<span class="w">    </span>generate_report

<span class="w">    </span>log_message<span class="w"> </span><span class="s2">"=== Filesystem Health Check Completed ==="</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Health check completed. Report available at: </span><span class="nv">$REPORT_FILE</span><span class="s2">"</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Log file: </span><span class="nv">$LOG_FILE</span><span class="s2">"</span>
<span class="o">}</span>

main<span class="w"> </span><span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
</pre></div>
</div>
</section>
</section>
<section id="performance-testing-scripts">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Performance Testing Scripts</a><a class="headerlink" href="#performance-testing-scripts" title="Link to this heading"></a></h3>
<section id="storage-benchmark-suite">
<h4><a class="toc-backref" href="#id13" role="doc-backlink">Storage Benchmark Suite</a><a class="headerlink" href="#storage-benchmark-suite" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">"""</span>
<span class="sd">Storage Performance Benchmark Suite for Ubuntu 22.04</span>
<span class="sd">Tests various storage scenarios and generates performance reports</span>
<span class="sd">"""</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span><span class="w"> </span><span class="nc">StorageBenchmark</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_dir</span><span class="o">=</span><span class="s2">"/tmp/storage_test"</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">test_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_dd_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_name</span><span class="p">,</span> <span class="n">block_size</span><span class="o">=</span><span class="s2">"1M"</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Run DD-based I/O test"""</span>
        <span class="n">test_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">test_name</span><span class="si">}</span><span class="s2">.dat"</span>

        <span class="c1"># Write test</span>
        <span class="n">write_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'dd'</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'if=/dev/zero'</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'of=</span><span class="si">{</span><span class="n">test_file</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
               <span class="sa">f</span><span class="s1">'bs=</span><span class="si">{</span><span class="n">block_size</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'count=</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="s1">'conv=fdatasync'</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">write_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">write_start</span>

            <span class="c1"># Parse DD output for speed</span>
            <span class="n">write_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_dd_output</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

            <span class="c1"># Read test</span>
            <span class="n">read_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'dd'</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'if=</span><span class="si">{</span><span class="n">test_file</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="s1">'of=/dev/null'</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'bs=</span><span class="si">{</span><span class="n">block_size</span><span class="si">}</span><span class="s1">'</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">read_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">read_start</span>

            <span class="n">read_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_dd_output</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

            <span class="c1"># Cleanup</span>
            <span class="n">test_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">'write_time'</span><span class="p">:</span> <span class="n">write_time</span><span class="p">,</span>
                <span class="s1">'read_time'</span><span class="p">:</span> <span class="n">read_time</span><span class="p">,</span>
                <span class="s1">'write_speed'</span><span class="p">:</span> <span class="n">write_speed</span><span class="p">,</span>
                <span class="s1">'read_speed'</span><span class="p">:</span> <span class="n">read_speed</span><span class="p">,</span>
                <span class="s1">'block_size'</span><span class="p">:</span> <span class="n">block_size</span><span class="p">,</span>
                <span class="s1">'data_size'</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">count</span><span class="si">}{</span><span class="n">block_size</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">'error'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse_dd_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dd_stderr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Parse DD output to extract transfer rate"""</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

        <span class="c1"># Look for patterns like "1.0 GB/s" or "500 MB/s"</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'(\d+\.?\d*)\s*([KMGT]?B/s)'</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">dd_stderr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">return</span> <span class="s2">"Unknown"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_fio_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_name</span><span class="p">,</span> <span class="n">job_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Run FIO benchmark if available"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Check if fio is available</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">'which'</span><span class="p">,</span> <span class="s1">'fio'</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Create FIO job file</span>
            <span class="n">job_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">test_name</span><span class="si">}</span><span class="s2">.fio"</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">job_file</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">job_config</span><span class="p">)</span>

            <span class="c1"># Run FIO</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">'fio'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_file</span><span class="p">),</span> <span class="s1">'--output-format=json'</span><span class="p">],</span>
                                  <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fio_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                <span class="n">job_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">fio_data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">'error'</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">}</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">'error'</span><span class="p">:</span> <span class="s1">'FIO not available'</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_sequential_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Run sequential I/O tests"""</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Running sequential I/O tests..."</span><span class="p">)</span>

        <span class="c1"># Various block sizes</span>
        <span class="n">block_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'4K'</span><span class="p">,</span> <span class="s1">'64K'</span><span class="p">,</span> <span class="s1">'1M'</span><span class="p">,</span> <span class="s1">'4M'</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">bs</span> <span class="ow">in</span> <span class="n">block_sizes</span><span class="p">:</span>
            <span class="n">test_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"sequential_</span><span class="si">{</span><span class="n">bs</span><span class="si">}</span><span class="s2">"</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Testing </span><span class="si">{</span><span class="n">bs</span><span class="si">}</span><span class="s2"> blocks..."</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dd_test</span><span class="p">(</span><span class="n">test_name</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="mi">256</span> <span class="k">if</span> <span class="n">bs</span> <span class="o">==</span> <span class="s1">'4M'</span> <span class="k">else</span> <span class="mi">1024</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">test_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_random_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Run random I/O tests using FIO"""</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Running random I/O tests..."</span><span class="p">)</span>

        <span class="c1"># Random read test</span>
        <span class="n">random_read_config</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">[random_read]</span>
<span class="s2">ioengine=libaio</span>
<span class="s2">rw=randread</span>
<span class="s2">bs=4k</span>
<span class="s2">direct=1</span>
<span class="s2">size=100M</span>
<span class="s2">numjobs=1</span>
<span class="s2">runtime=30</span>
<span class="s2">group_reporting</span>
<span class="s2">filename=</span><span class="si">{}</span><span class="s2">/random_read.dat</span>
<span class="s2">"""</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_dir</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_fio_test</span><span class="p">(</span><span class="s2">"random_read"</span><span class="p">,</span> <span class="n">random_read_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">'random_read'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

        <span class="c1"># Random write test</span>
        <span class="n">random_write_config</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">[random_write]</span>
<span class="s2">ioengine=libaio</span>
<span class="s2">rw=randwrite</span>
<span class="s2">bs=4k</span>
<span class="s2">direct=1</span>
<span class="s2">size=100M</span>
<span class="s2">numjobs=1</span>
<span class="s2">runtime=30</span>
<span class="s2">group_reporting</span>
<span class="s2">filename=</span><span class="si">{}</span><span class="s2">/random_write.dat</span>
<span class="s2">"""</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_dir</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_fio_test</span><span class="p">(</span><span class="s2">"random_write"</span><span class="p">,</span> <span class="n">random_write_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">'random_write'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Generate performance report"""</span>
        <span class="n">report_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dir</span> <span class="o">/</span> <span class="s2">"benchmark_report.json"</span>

        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'timestamp'</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">'%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S'</span><span class="p">),</span>
            <span class="s1">'test_directory'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_dir</span><span class="p">),</span>
            <span class="s1">'system_info'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_system_info</span><span class="p">(),</span>
            <span class="s1">'results'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>
        <span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_file</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Generate human-readable summary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Detailed report saved to: </span><span class="si">{</span><span class="n">report_file</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_system_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get system information"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get CPU info</span>
            <span class="n">cpu_info</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">'lscpu'</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span>

            <span class="c1"># Get memory info</span>
            <span class="n">mem_info</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">'free'</span><span class="p">,</span> <span class="s1">'-h'</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span>

            <span class="c1"># Get storage info</span>
            <span class="n">storage_info</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">'lsblk'</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">'cpu'</span><span class="p">:</span> <span class="n">cpu_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)[:</span><span class="mi">10</span><span class="p">],</span>  <span class="c1"># First 10 lines</span>
                <span class="s1">'memory'</span><span class="p">:</span> <span class="n">mem_info</span><span class="p">,</span>
                <span class="s1">'storage'</span><span class="p">:</span> <span class="n">storage_info</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">'error'</span><span class="p">:</span> <span class="s1">'Could not gather system info'</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Print benchmark summary"""</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"STORAGE BENCHMARK SUMMARY"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"="</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">test_name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">'error'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="n">test_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">:"</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">'write_speed'</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Write Speed: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">'write_speed'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Read Speed:  </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">'read_speed'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">'jobs'</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>  <span class="c1"># FIO result</span>
                    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">'jobs'</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="s1">'read'</span> <span class="ow">in</span> <span class="n">job</span><span class="p">:</span>
                            <span class="n">iops</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">'read'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'iops'</span><span class="p">,</span> <span class="s1">'N/A'</span><span class="p">)</span>
                            <span class="n">bw</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">'read'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'bw'</span><span class="p">,</span> <span class="s1">'N/A'</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Read IOPS:   </span><span class="si">{</span><span class="n">iops</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Read BW:     </span><span class="si">{</span><span class="n">bw</span><span class="si">}</span><span class="s2"> KB/s"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">'write'</span> <span class="ow">in</span> <span class="n">job</span><span class="p">:</span>
                            <span class="n">iops</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">'write'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'iops'</span><span class="p">,</span> <span class="s1">'N/A'</span><span class="p">)</span>
                            <span class="n">bw</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">'write'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'bw'</span><span class="p">,</span> <span class="s1">'N/A'</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Write IOPS:  </span><span class="si">{</span><span class="n">iops</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Write BW:    </span><span class="si">{</span><span class="n">bw</span><span class="si">}</span><span class="s2"> KB/s"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="n">test_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">: ERROR - </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_all_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Run complete benchmark suite"""</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Starting Storage Benchmark Suite"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"This may take several minutes..."</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_sequential_tests</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_random_tests</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_report</span><span class="p">()</span>

        <span class="c1"># Cleanup</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.dat"</span><span class="p">):</span>
            <span class="n">file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">test_dir</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">test_dir</span> <span class="o">=</span> <span class="s2">"/tmp/storage_test"</span>

    <span class="n">benchmark</span> <span class="o">=</span> <span class="n">StorageBenchmark</span><span class="p">(</span><span class="n">test_dir</span><span class="p">)</span>
    <span class="n">benchmark</span><span class="o">.</span><span class="n">run_all_tests</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="installation-and-usage-instructions">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Installation and Usage Instructions</a><a class="headerlink" href="#installation-and-usage-instructions" title="Link to this heading"></a></h3>
<section id="setting-up-the-environment">
<h4><a class="toc-backref" href="#id15" role="doc-backlink">Setting Up the Environment</a><a class="headerlink" href="#setting-up-the-environment" title="Link to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install required packages</span>
sudo<span class="w"> </span>apt<span class="w"> </span>update
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>python3-pip<span class="w"> </span>smartmontools<span class="w"> </span>fio

<span class="c1"># Install Python dependencies</span>
pip3<span class="w"> </span>install<span class="w"> </span>pyyaml

<span class="c1"># Make scripts executable</span>
chmod<span class="w"> </span>+x<span class="w"> </span>*.py<span class="w"> </span>*.sh

<span class="c1"># Create necessary directories</span>
sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/var/log<span class="w"> </span>/backup
</pre></div>
</div>
</section>
<section id="script-configuration">
<h4><a class="toc-backref" href="#id16" role="doc-backlink">Script Configuration</a><a class="headerlink" href="#script-configuration" title="Link to this heading"></a></h4>
<p><strong>Storage Monitor Configuration:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up cron job for automated monitoring</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">"0 */6 * * * root /path/to/storage-monitor.py"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/crontab

<span class="c1"># Configure log rotation</span>
sudo<span class="w"> </span>tee<span class="w"> </span>/etc/logrotate.d/storage-monitor<span class="w"> </span><span class="s">&lt;&lt; EOF</span>
<span class="s">/var/log/storage-monitor.log {</span>
<span class="s">    daily</span>
<span class="s">    rotate 30</span>
<span class="s">    compress</span>
<span class="s">    missingok</span>
<span class="s">    create 644 root root</span>
<span class="s">}</span>
<span class="s">EOF</span>
</pre></div>
</div>
<p><strong>NFS Manager Setup:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install NFS utilities</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>nfs-common

<span class="c1"># Create configuration file</span>
sudo<span class="w"> </span>tee<span class="w"> </span>/etc/nfs-mounts.yaml<span class="w"> </span><span class="s">&lt;&lt; EOF</span>
<span class="s">mounts:</span>
<span class="s">  - server: "your-nfs-server.local"</span>
<span class="s">    export: "/export/data"</span>
<span class="s">    mountpoint: "/mnt/nfs-data"</span>
<span class="s">    options: "rw,sync,hard,intr"</span>
<span class="s">    auto_mount: true</span>
<span class="s">timeout: 30</span>
<span class="s">retry_count: 3</span>
<span class="s">EOF</span>
</pre></div>
</div>
</section>
</section>
<section id="integration-examples">
<h3><a class="toc-backref" href="#id17" role="doc-backlink">Integration Examples</a><a class="headerlink" href="#integration-examples" title="Link to this heading"></a></h3>
<section id="systemd-service-integration">
<h4><a class="toc-backref" href="#id18" role="doc-backlink">Systemd Service Integration</a><a class="headerlink" href="#systemd-service-integration" title="Link to this heading"></a></h4>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/systemd/system/storage-monitor.service</span>
<span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Storage Health Monitor</span>
<span class="na">After</span><span class="o">=</span><span class="s">multi-user.target</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">oneshot</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/bin/storage-monitor.py</span>
<span class="na">User</span><span class="o">=</span><span class="s">root</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Enable and start the service</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>daemon-reload
sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>storage-monitor.service
sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>storage-monitor.service
</pre></div>
</div>
</section>
<section id="custom-alerts-integration">
<h4><a class="toc-backref" href="#id19" role="doc-backlink">Custom Alerts Integration</a><a class="headerlink" href="#custom-alerts-integration" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Email alert integration</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">smtplib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">email.mime.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">MIMEText</span>

<span class="k">def</span><span class="w"> </span><span class="nf">send_alert</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">'Subject'</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">'From'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'storage-monitor@yourserver.com'</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">'To'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'admin@yourserver.com'</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</pre></div>
</div>
<p>These scripts provide a comprehensive foundation for storage management automation on Ubuntu 22.04. They can be customized and extended based on specific requirements and integrated into larger system management frameworks.</p>
</section>
</section>
</section>
</div>
</div>
</section>
</div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
</body>
</html>